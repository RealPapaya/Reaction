<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³½é¦¬ç‰©ç†å¼•æ“æ¸¬è©¦</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Inter', sans-serif;
            background: #1a1a1a;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
        }

        #raceCanvas {
            display: block;
            width: 100%;
            height: 600px;
            background: #2a2a2a;
            border: 2px solid #444;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            background: #8B5CF6;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background: #7C3AED;
        }

        .leaderboard {
            background: #2a2a2a;
            padding: 20px;
            border: 2px solid #444;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 4px 0;
            background: #333;
        }

        .leaderboard-item.boxed {
            border-left: 4px solid #EF4444;
        }

        .debug-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2a2a2a;
            padding: 15px;
            border: 2px solid #444;
            max-width: 300px;
            font-size: 12px;
        }

        .debug-item {
            margin: 5px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ‡ çœŸå¯¦è³½é¦¬ç‰©ç†å¼•æ“æ¸¬è©¦</h1>

        <div class="controls">
            <button id="startBtn">é–‹å§‹æ¯”è³½</button>
            <button id="pauseBtn">æš«åœ</button>
            <button id="resetBtn">é‡ç½®</button>
        </div>

        <canvas id="raceCanvas" width="1200" height="600"></canvas>

        <div class="leaderboard">
            <h3>å³æ™‚æ’å</h3>
            <div id="leaderboardContainer"></div>
        </div>
    </div>

    <div class="debug-panel" id="debugPanel">
        <h4>é™¤éŒ¯è³‡è¨Š</h4>
        <div id="debugInfo"></div>
    </div>

    <!-- å¼•å…¥æ¨¡çµ„ -->
    <script src="core/FrenetCoordinates.js"></script>
    <script src="core/SteeringBehaviors.js"></script>
    <script src="core/PhysicsEngine.js"></script>
    <script src="ai/JockeyAI.js"></script>
    <script src="RaceSimulator.js"></script>

    <script>
        // ====================================
        // æ¸¬è©¦è¨­å®š
        // ====================================

        // å»ºç«‹æ¸¬è©¦è³½é“ï¼ˆ**æ“å ´å½¢**ï¼šå…©æ¢ç›´ç·š + å…©å€‹å½é“ï¼‰
        function createTestTrack() {
            const points = [];
            const centerX = 600;
            const centerY = 300;
            const straightLength = 400;  // ç›´ç·šæ®µé•·åº¦
            const cornerRadius = 200;    // å½é“åŠå¾‘

            // åˆ†æˆå››å€‹éƒ¨åˆ†ï¼šä¸Šç›´ç·šã€å³å½ã€ä¸‹ç›´ç·šã€å·¦å½
            const numPointsPerSegment = 25;

            // 1. ä¸Šç›´ç·šï¼ˆå‘å³ï¼‰
            for (let i = 0; i < numPointsPerSegment; i++) {
                const t = i / numPointsPerSegment;
                points.push({
                    x: centerX - straightLength / 2 + t * straightLength,
                    y: centerY - cornerRadius
                });
            }

            // 2. å³å½é“ï¼ˆ180åº¦ï¼‰
            for (let i = 0; i < numPointsPerSegment; i++) {
                const t = i / numPointsPerSegment;
                const angle = -Math.PI / 2 + t * Math.PI;  // -90åº¦ åˆ° +90åº¦
                points.push({
                    x: centerX + straightLength / 2 + Math.cos(angle) * cornerRadius,
                    y: centerY + Math.sin(angle) * cornerRadius
                });
            }

            // 3. ä¸‹ç›´ç·šï¼ˆå‘å·¦ï¼‰
            for (let i = 0; i < numPointsPerSegment; i++) {
                const t = i / numPointsPerSegment;
                points.push({
                    x: centerX + straightLength / 2 - t * straightLength,
                    y: centerY + cornerRadius
                });
            }

            // 4. å·¦å½é“ï¼ˆ180åº¦ï¼‰
            for (let i = 0; i < numPointsPerSegment; i++) {
                const t = i / numPointsPerSegment;
                const angle = Math.PI / 2 + t * Math.PI;  // +90åº¦ åˆ° +270åº¦
                points.push({
                    x: centerX - straightLength / 2 + Math.cos(angle) * cornerRadius,
                    y: centerY + Math.sin(angle) * cornerRadius
                });
            }

            return points;
        }

        // å»ºç«‹æ¸¬è©¦é¦¬åŒ¹
        function createTestHorses() {
            const runningStyles = ['é€ƒ', 'å‰', 'è¿½', 'æ®¿'];
            const horses = [];

            for (let i = 0; i < 8; i++) {
                horses.push({
                    id: i + 1,
                    name: `é¦¬${i + 1}è™Ÿ`,
                    runningStyle: runningStyles[i % 4],
                    competitiveFactor: 80 + Math.random() * 20,
                    gateNumber: i + 1
                });
            }

            return horses;
        }

        // ====================================
        // åˆå§‹åŒ–
        // ====================================

        const canvas = document.getElementById('raceCanvas');
        const ctx = canvas.getContext('2d');
        const trackPath = createTestTrack();
        const horses = createTestHorses();
        const simulator = new RaceSimulator(trackPath, horses);

        let animationId = null;

        // ====================================
        // æ¸²æŸ“
        // ====================================

        function render() {
            // æ¸…ç©ºç•«å¸ƒ
            ctx.fillStyle = '#7EC850';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç¹ªè£½è³½é“
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            trackPath.forEach((point, i) => {
                if (i === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            });
            ctx.closePath();
            ctx.stroke();

            // ç¹ªè£½èµ·è·‘/çµ‚é»ç·š
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(trackPath[0].x - 2, trackPath[0].y - 100, 4, 200);

            // ç¹ªè£½é¦¬åŒ¹ï¼ˆä½¿ç”¨ Z-orderingï¼‰
            const horsePositions = simulator.getHorseWorldPositions();

            // **ç•«å®¶æ¼”ç®—æ³•**ï¼šæŒ‰ Y åº§æ¨™æ’åºï¼Œå…ˆç•«é è™•ï¼ˆYå°ï¼‰ï¼Œå¾Œç•«è¿‘è™•ï¼ˆYå¤§ï¼‰
            horsePositions.sort((a, b) => a.worldY - b.worldY);

            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'];

            horsePositions.forEach((horse, index) => {
                ctx.save();
                ctx.translate(horse.worldX, horse.worldY);
                ctx.rotate(horse.heading);

                // é¦¬åŒ¹é•·æ–¹å½¢ï¼ˆè½‰ 90 åº¦ï¼šå¯¬ 28ï¼Œé«˜ 16ï¼ŒåƒçœŸå¯¦é¦¬çš„å½¢ç‹€ï¼‰
                const horseWidth = 28;  // é¦¬çš„é•·åº¦ï¼ˆæ²¿è‘—å‰é€²æ–¹å‘ï¼‰
                const horseHeight = 16; // é¦¬çš„å¯¬åº¦ï¼ˆæ©«å‘ï¼‰
                ctx.fillStyle = colors[index];
                ctx.fillRect(-horseWidth / 2, -horseHeight / 2, horseWidth, horseHeight);

                // å¤–æ¡†ï¼ˆè®“ç¢°æ’æ›´æ˜é¡¯ï¼‰
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.strokeRect(-horseWidth / 2, -horseHeight / 2, horseWidth, horseHeight);

                // ç·¨è™Ÿ
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(horse.id, 0, 0);

                // è¢«å›°æ¨™è¨˜
                if (horse.isBoxedIn) {
                    ctx.fillStyle = '#EF4444';
                    ctx.fillText('!', 10, -12);
                }

                ctx.restore();

                // è»Œè·¡
                if (horse.positionHistory && horse.positionHistory.length > 2) {
                    ctx.strokeStyle = `rgba(${colors[index].substring(1, 3)}, ${colors[index].substring(3, 5)}, ${colors[index].substring(5, 7)}, 0.3)`;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    horse.positionHistory.forEach((pos, i) => {
                        const worldPos = simulator.frenet.frenetToWorld(pos.s, pos.d);
                        if (i === 0) {
                            ctx.moveTo(worldPos.x, worldPos.y);
                        } else {
                            ctx.lineTo(worldPos.x, worldPos.y);
                        }
                    });
                    ctx.stroke();
                }
            });
        }

        function updateUI() {
            // æ›´æ–°æ’è¡Œæ¦œ
            const state = simulator.getRaceState();
            const leaderboard = state.leaderboard;
            const container = document.getElementById('leaderboardContainer');

            container.innerHTML = leaderboard.map(item => `
                <div class="leaderboard-item ${item.isBoxedIn ? 'boxed' : ''}">
                    <span>${item.position}. ${item.horse.name} (${item.horse.runningStyle})</span>
                    <span>${item.distance.toFixed(1)}m ${item.isBoxedIn ? 'ğŸ”’' : ''}</span>
                </div>
            `).join('');

            // æ›´æ–°é™¤éŒ¯é¢æ¿ï¼ˆé¡¯ç¤ºç¬¬ä¸€åŒ¹é¦¬çš„è³‡è¨Šï¼‰
            if (horses.length > 0) {
                const debugInfo = simulator.getDebugInfo(1);
                if (debugInfo) {
                    document.getElementById('debugInfo').innerHTML = `
                        <div class="debug-item">S: ${debugInfo.frenet.s.toFixed(2)}m</div>
                        <div class="debug-item">D: ${debugInfo.frenet.d.toFixed(2)}m</div>
                        <div class="debug-item">Speed: ${debugInfo.speed.toFixed(2)}m/s</div>
                        <div class="debug-item">Lateral Speed: ${debugInfo.lateralSpeed.toFixed(3)}m/s</div>
                        <div class="debug-item">Boxed: ${debugInfo.isBoxedIn ? 'YES âš ï¸' : 'NO'}</div>
                        <div class="debug-item">Anxiety: ${debugInfo.anxiety.toFixed(2)}</div>
                        <div class="debug-item">Corner R: ${debugInfo.cornerRadius === Infinity ? 'âˆ' : debugInfo.cornerRadius.toFixed(1)}m</div>
                    `;
                }
            }
        }

        // ====================================
        // ä¸»å¾ªç’°
        // ====================================

        function gameLoop() {
            simulator.update();
            render();
            updateUI();

            if (simulator.isRunning) {
                animationId = requestAnimationFrame(gameLoop);
            } else {
                // æ¯”è³½çµæŸ
                const results = simulator.getResults();
                console.log('æ¯”è³½çµæœ:', results);
                alert('æ¯”è³½çµæŸï¼\n' + results.map(r =>
                    `${r.position}. ${r.horse.name} - ${r.finishTime.toFixed(2)}ç§’`
                ).join('\n'));
            }
        }

        // ====================================
        // æ§åˆ¶
        // ====================================

        document.getElementById('startBtn').addEventListener('click', () => {
            simulator.startRace();
            gameLoop();
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            simulator.stopRace();
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            simulator.stopRace();
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            simulator.initializeHorses();
            render();
            updateUI();
        });

        // åˆå§‹æ¸²æŸ“
        simulator.initializeHorses();
        render();
        updateUI();
    </script>
</body>

</html>