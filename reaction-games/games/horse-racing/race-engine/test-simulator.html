<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³½é¦¬ç‰©ç†å¼•æ“æ¸¬è©¦ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Inter', sans-serif;
            background: #1a1a1a;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
        }

        #raceCanvas {
            display: block;
            width: 100%;
            height: 600px;
            background: #2a2a2a;
            border: 2px solid #444;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            background: #8B5CF6;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background: #7C3AED;
        }

        .leaderboard {
            background: #2a2a2a;
            padding: 20px;
            border: 2px solid #444;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 4px 0;
            background: #333;
        }

        .leaderboard-item.boxed {
            border-left: 4px solid #EF4444;
        }

        .debug-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2a2a2a;
            padding: 15px;
            border: 2px solid #444;
            max-width: 300px;
            font-size: 12px;
        }

        .debug-item {
            margin: 5px 0;
        }

        .info-box {
            background: #2a2a2a;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #8B5CF6;
        }

        .info-box h3 {
            margin-top: 0;
            color: #8B5CF6;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ‡ çœŸå¯¦è³½é¦¬ç‰©ç†å¼•æ“æ¸¬è©¦ï¼ˆä¿®æ­£ç‰ˆï¼‰</h1>

        <div class="info-box">
            <h3>ğŸ“ æ¯”ä¾‹èªªæ˜</h3>
            <p>
                <strong>è³½é“é•·åº¦ï¼š</strong>ç´„ 1314 ç±³ï¼ˆ1.7 åˆ†é˜å®Œè³½ï¼‰<br>
                <strong>ç‰©ç†å–®ä½ï¼š</strong>1 ç±³ = 2.2 åƒç´ <br>
                <strong>è·‘é“é–“éš”ï¼š</strong>2.0 ç±³ = 4.4 åƒç´ <br>
                <strong>é¦¬åŒ¹å¤§å°ï¼š</strong>é•· 2.0m Ã— å¯¬ 0.8mï¼ˆè¦–è¦ºï¼š8px Ã— 4pxï¼‰<br>
                <strong>è³½é“å……åˆ†åˆ©ç”¨ç•«å¸ƒç©ºé–“</strong>
            </p>
        </div>

        <div class="controls">
            <button id="startBtn">é–‹å§‹æ¯”è³½</button>
            <button id="pauseBtn">æš«åœ</button>
            <button id="resetBtn">é‡ç½®</button>
        </div>

        <canvas id="raceCanvas" width="1200" height="600"></canvas>

        <div class="leaderboard">
            <h3>å³æ™‚æ’å</h3>
            <div id="leaderboardContainer"></div>
        </div>
    </div>

    <div class="debug-panel" id="debugPanel">
        <h4>é™¤éŒ¯è³‡è¨Š</h4>
        <div id="debugInfo"></div>
    </div>

    <!-- å¼•å…¥æ¨¡çµ„ï¼ˆä½¿ç”¨ core/ å’Œ ai/ è³‡æ–™å¤¾çµæ§‹ï¼‰-->
    <script src="core/FrenetCoordinates.js"></script>
    <script src="core/SteeringBehaviors.js"></script>
    <script src="core/PhysicsEngine.js"></script>
    <script src="ai/JockeyAI.js"></script>
    <script src="RaceSimulator.js"></script>

    <script>
        // ====================================
        // ğŸ¯ é—œéµä¿®æ­£ï¼šç‰©ç†-è¦–è¦ºæ¯”ä¾‹è½‰æ›
        // ====================================

        // ç‰©ç†å–®ä½ï¼šç±³
        // è¦–è¦ºå–®ä½ï¼šåƒç´ 
        const PIXELS_PER_METER = 2.2;  // 1 ç±³ = 2.2 åƒç´ ï¼ˆæ”¾å¤§è³½é“ï¼‰

        // **é—œéµä¿®æ­£**ï¼šè¦–è¦ºå°ºå¯¸å¿…é ˆç¬¦åˆç‰©ç†å°ºå¯¸
        // ç‰©ç†ï¼šbodyRadius = 0.6m â†’ ç›´å¾‘ 1.2m
        // è¦–è¦ºï¼š1.2m * 2.2 px/m = 2.64px â†’ ä½†é€™å¤ªå°ï¼Œæˆ‘å€‘ç”¨ 3 å€æ”¾å¤§
        const VISUAL_SCALE = 3.0; // è¦–è¦ºæ”¾å¤§å€æ•¸

        // ç‰©ç†å°ºå¯¸ï¼ˆç±³ï¼‰
        const HORSE_PHYSICAL_LENGTH = 2.0;   // é¦¬é•· 2.0 ç±³
        const HORSE_PHYSICAL_WIDTH = 1.2;    // é¦¬å¯¬ 1.2 ç±³ ï¼ˆ= bodyRadius * 2ï¼‰

        // è¦–è¦ºå°ºå¯¸ï¼ˆåƒç´ ï¼‰
        const HORSE_VISUAL_LENGTH = HORSE_PHYSICAL_LENGTH * PIXELS_PER_METER * VISUAL_SCALE;  // 2.0*2.2*3 = 13.2
        const HORSE_VISUAL_WIDTH = HORSE_PHYSICAL_WIDTH * PIXELS_PER_METER * VISUAL_SCALE;    // 1.2*2.2*3 = 7.92

        console.log('è¦–è¦ºå°ºå¯¸:', { length: HORSE_VISUAL_LENGTH, width: HORSE_VISUAL_WIDTH });

        // ====================================
        // æ¸¬è©¦è¨­å®š
        // ====================================

        // å»ºç«‹æ¸¬è©¦è³½é“ï¼ˆ**ç‰©ç†å–®ä½ï¼šç±³**ï¼‰
        function createTestTrack() {
            const points = [];

            // è³½é“ç‰©ç†å°ºå¯¸ï¼ˆç±³ï¼‰
            // ç•«å¸ƒï¼š1200Ã—600 pxï¼Œæ¯”ä¾‹ 2.2 px/mï¼Œç•™ 10% é‚Šç•Œ
            // å¯ç”¨ï¼š1080Ã—540 px = 490Ã—245 ç±³
            const straightLength = 280;   // ç›´ç·šæ®µ 280 ç±³ï¼ˆæ¥è¿‘æ¥µé™ï¼‰
            const cornerRadius = 120;     // å½é“åŠå¾‘ 120 ç±³
            // è³½é“å°ºå¯¸ï¼šé•· (280+2Ã—120=520m) Ã— å¯¬ (2Ã—120=240m)
            // è¦–è¦ºï¼š1144Ã—528 pxï¼ˆå‰›å¥½å¡«æ»¿ç•«å¸ƒï¼‰
            // ç¸½é•· â‰ˆ 2Ã—280 + 2Ã—(Ï€Ã—120) â‰ˆ 560 + 754 = 1314ç±³ï¼ˆç´„ 1.7 åˆ†é˜ï¼‰

            const centerX = 0;
            const centerY = 0;

            const numPointsPerSegment = 25;

            // 1. ä¸Šç›´ç·šï¼ˆå‘å³ï¼‰
            for (let i = 0; i < numPointsPerSegment; i++) {
                const t = i / numPointsPerSegment;
                points.push({
                    x: centerX - straightLength / 2 + t * straightLength,
                    y: centerY - cornerRadius
                });
            }

            // 2. å³å½é“ï¼ˆ180åº¦ï¼‰
            for (let i = 0; i < numPointsPerSegment; i++) {
                const t = i / numPointsPerSegment;
                const angle = -Math.PI / 2 + t * Math.PI;
                points.push({
                    x: centerX + straightLength / 2 + Math.cos(angle) * cornerRadius,
                    y: centerY + Math.sin(angle) * cornerRadius
                });
            }

            // 3. ä¸‹ç›´ç·šï¼ˆå‘å·¦ï¼‰
            for (let i = 0; i < numPointsPerSegment; i++) {
                const t = i / numPointsPerSegment;
                points.push({
                    x: centerX + straightLength / 2 - t * straightLength,
                    y: centerY + cornerRadius
                });
            }

            // 4. å·¦å½é“ï¼ˆ180åº¦ï¼‰
            for (let i = 0; i < numPointsPerSegment; i++) {
                const t = i / numPointsPerSegment;
                const angle = Math.PI / 2 + t * Math.PI;
                points.push({
                    x: centerX - straightLength / 2 + Math.cos(angle) * cornerRadius,
                    y: centerY + Math.sin(angle) * cornerRadius
                });
            }

            return points;
        }

        // ç‰©ç†åº§æ¨™ â†’ ç•«å¸ƒåº§æ¨™
        function physicsToCanvas(physicsX, physicsY) {
            const canvasCenterX = 600;
            const canvasCenterY = 300;
            return {
                x: canvasCenterX + physicsX * PIXELS_PER_METER,
                y: canvasCenterY + physicsY * PIXELS_PER_METER
            };
        }

        // å»ºç«‹æ¸¬è©¦é¦¬åŒ¹
        function createTestHorses() {
            const runningStyles = ['é€ƒ', 'å‰', 'è¿½', 'æ®¿'];
            const horses = [];

            for (let i = 0; i < 8; i++) {
                horses.push({
                    id: i + 1,
                    name: `é¦¬${i + 1}è™Ÿ`,
                    runningStyle: runningStyles[i % 4],
                    competitiveFactor: 80 + Math.random() * 20,
                    gateNumber: i + 1
                });
            }

            return horses;
        }

        // ====================================
        // åˆå§‹åŒ–
        // ====================================

        const canvas = document.getElementById('raceCanvas');
        const ctx = canvas.getContext('2d');
        const trackPath = createTestTrack();  // ç‰©ç†åº§æ¨™
        const horses = createTestHorses();
        const simulator = new RaceSimulator(trackPath, horses);

        let animationId = null;

        // ====================================
        // æ¸²æŸ“
        // ====================================

        function render() {
            // æ¸…ç©ºç•«å¸ƒ
            ctx.fillStyle = '#7EC850';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç¹ªè£½è³½é“ï¼ˆè½‰æ›ç‚ºç•«å¸ƒåº§æ¨™ï¼‰
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            trackPath.forEach((point, i) => {
                const canvasPos = physicsToCanvas(point.x, point.y);
                if (i === 0) {
                    ctx.moveTo(canvasPos.x, canvasPos.y);
                } else {
                    ctx.lineTo(canvasPos.x, canvasPos.y);
                }
            });
            ctx.closePath();
            ctx.stroke();

            // ç¹ªè£½èµ·è·‘/çµ‚é»ç·š
            const startPos = physicsToCanvas(trackPath[0].x, trackPath[0].y);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(startPos.x - 2, startPos.y - 100, 4, 200);

            // ç¹ªè£½è·‘é“åˆ†éš”ç·šï¼ˆ8æ¢è·‘é“ï¼‰
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 1;
            const trackWidth = 18; // ç‰©ç†å¯¬åº¦ 18 ç±³
            for (let lane = 1; lane < 8; lane++) {
                const laneD = lane * 2.0; // æ¯æ¢è·‘é“é–“éš” 2 ç±³
                ctx.beginPath();
                trackPath.forEach((point, i) => {
                    const worldPos = simulator.frenet.frenetToWorld(
                        i * (simulator.frenet.pathLength / trackPath.length),
                        laneD
                    );
                    const canvasPos = physicsToCanvas(worldPos.x, worldPos.y);
                    if (i === 0) {
                        ctx.moveTo(canvasPos.x, canvasPos.y);
                    } else {
                        ctx.lineTo(canvasPos.x, canvasPos.y);
                    }
                });
                ctx.stroke();
            }

            // ç¹ªè£½é¦¬åŒ¹ï¼ˆä½¿ç”¨ Z-orderingï¼‰
            const horsePositions = simulator.getHorseWorldPositions();
            horsePositions.sort((a, b) => a.worldY - b.worldY);

            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'];

            horsePositions.forEach((horse, index) => {
                // è½‰æ›ç‚ºç•«å¸ƒåº§æ¨™
                const canvasPos = physicsToCanvas(horse.worldX, horse.worldY);

                ctx.save();
                ctx.translate(canvasPos.x, canvasPos.y);
                ctx.rotate(horse.heading);

                // é¦¬åŒ¹çŸ©å½¢ï¼ˆæ­£ç¢ºæ¯”ä¾‹ï¼‰
                ctx.fillStyle = colors[index];
                ctx.fillRect(
                    -HORSE_VISUAL_LENGTH / 2,
                    -HORSE_VISUAL_WIDTH / 2,
                    HORSE_VISUAL_LENGTH,
                    HORSE_VISUAL_WIDTH
                );

                // å¤–æ¡†
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.strokeRect(
                    -HORSE_VISUAL_LENGTH / 2,
                    -HORSE_VISUAL_WIDTH / 2,
                    HORSE_VISUAL_LENGTH,
                    HORSE_VISUAL_WIDTH
                );

                // ç·¨è™Ÿ
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(horse.id, 0, 0);

                // è¢«å›°æ¨™è¨˜
                if (horse.isBoxedIn) {
                    ctx.fillStyle = '#EF4444';
                    ctx.beginPath();
                    ctx.arc(0, -8, 3, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();

                // æ‹‰ç·šè™Ÿç¢¼æ¨™ç¤ºï¼ˆåƒè³½é¦¬è½‰æ’­ï¼‰
                const leaderboard = simulator.getCurrentLeaderboard();
                const position = leaderboard.findIndex(item => item.horse.id === horse.id) + 1;

                // **é—œéµä¿®æ­£**ï¼šæ¨™ç±¤æ”¾åœ¨æ“å ´å…§å´ï¼Œä¸æ“‹åˆ°è³½é“
                // 1. è¨ˆç®—è³½é“ä¸­å¿ƒé»ï¼ˆç‰©ç†åº§æ¨™ 0,0ï¼‰
                const centerCanvas = physicsToCanvas(0, 0);

                // 2. è¨ˆç®—é¦¬åŒ¹åˆ°ä¸­å¿ƒçš„æ–¹å‘å‘é‡
                const toCenterX = centerCanvas.x - canvasPos.x;
                const toCenterY = centerCanvas.y - canvasPos.y;
                const distToCenter = Math.sqrt(toCenterX * toCenterX + toCenterY * toCenterY);

                // 3. æ¨™ç±¤ä½ç½®ï¼šåœ¨é¦¬åŒ¹èˆ‡ä¸­å¿ƒä¹‹é–“ï¼Œè·é›¢é¦¬åŒ¹ 100px
                const labelDistance = Math.min(100, distToCenter * 0.5); // **æ‹‰é•·** 60->100px
                const labelX = canvasPos.x + (toCenterX / distToCenter) * labelDistance;
                const labelY = canvasPos.y + (toCenterY / distToCenter) * labelDistance;

                // æ‹‰ç·š
                ctx.strokeStyle = colors[index];
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(canvasPos.x, canvasPos.y);
                ctx.lineTo(labelX, labelY);
                ctx.stroke();

                // æ¨™ç±¤èƒŒæ™¯
                const labelText = `${position}. #${horse.id} ${horse.name}`;
                ctx.font = 'bold 11px Arial';
                const textWidth = ctx.measureText(labelText).width;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(labelX - textWidth / 2 - 4, labelY - 8, textWidth + 8, 16);

                // æ¨™ç±¤æ–‡å­—
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(labelText, labelX, labelY);

                // è»Œè·¡ï¼ˆç‰©ç†åº§æ¨™è½‰ç•«å¸ƒåº§æ¨™ï¼‰
                if (horse.positionHistory && horse.positionHistory.length > 2) {
                    ctx.strokeStyle = colors[index].replace(')', ', 0.3)').replace('rgb', 'rgba');
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    horse.positionHistory.forEach((pos, i) => {
                        const worldPos = simulator.frenet.frenetToWorld(pos.s, pos.d);
                        const canvasPos = physicsToCanvas(worldPos.x, worldPos.y);
                        if (i === 0) {
                            ctx.moveTo(canvasPos.x, canvasPos.y);
                        } else {
                            ctx.lineTo(canvasPos.x, canvasPos.y);
                        }
                    });
                    ctx.stroke();
                }
            });
        }

        function updateUI() {
            // æ›´æ–°æ’è¡Œæ¦œ
            const state = simulator.getRaceState();
            const leaderboard = state.leaderboard;
            const container = document.getElementById('leaderboardContainer');

            container.innerHTML = leaderboard.map(item => `
                <div class="leaderboard-item ${item.isBoxedIn ? 'boxed' : ''}">
                    <span>${item.position}. ${item.horse.name} (${item.horse.runningStyle})</span>
                    <span>${item.distance.toFixed(1)}m ${item.isBoxedIn ? 'ğŸ”’' : ''}</span>
                </div>
            `).join('');

            // æ›´æ–°é™¤éŒ¯é¢æ¿
            if (horses.length > 0) {
                const debugInfo = simulator.getDebugInfo(1);
                if (debugInfo) {
                    document.getElementById('debugInfo').innerHTML = `
                        <div class="debug-item">S: ${debugInfo.frenet.s.toFixed(2)}m</div>
                        <div class="debug-item">D: ${debugInfo.frenet.d.toFixed(2)}m</div>
                        <div class="debug-item">Speed: ${debugInfo.speed.toFixed(2)}m/s</div>
                        <div class="debug-item">Lateral: ${debugInfo.lateralSpeed.toFixed(3)}m/s</div>
                        <div class="debug-item">Boxed: ${debugInfo.isBoxedIn ? 'YES âš ï¸' : 'NO'}</div>
                        <div class="debug-item">Anxiety: ${debugInfo.anxiety.toFixed(2)}</div>
                        <div class="debug-item">Corner R: ${debugInfo.cornerRadius === Infinity ? 'âˆ' : debugInfo.cornerRadius.toFixed(1)}m</div>
                    `;
                }
            }
        }

        // ====================================
        // ä¸»å¾ªç’°
        // ====================================

        function gameLoop() {
            simulator.update();
            render();
            updateUI();

            if (simulator.isRunning) {
                animationId = requestAnimationFrame(gameLoop);
            } else {
                // æ¯”è³½çµæŸ
                const results = simulator.getResults();
                console.log('æ¯”è³½çµæœ:', results);
                alert('æ¯”è³½çµæŸï¼\n' + results.map(r =>
                    `${r.position}. ${r.horse.name} - ${r.finishTime.toFixed(2)}ç§’`
                ).join('\n'));
            }
        }

        // ====================================
        // æ§åˆ¶
        // ====================================

        document.getElementById('startBtn').addEventListener('click', () => {
            simulator.startRace();
            gameLoop();
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            simulator.stopRace();
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            simulator.stopRace();
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            simulator.initializeHorses();
            render();
            updateUI();
        });

        // åˆå§‹æ¸²æŸ“
        simulator.initializeHorses();
        render();
        updateUI();
    </script>
</body>

</html>