<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é©é…å±¤æ¸¬è©¦ - RaceEngineAdapter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .test-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .test-panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status.pass {
            background: #10b981;
            color: white;
        }

        .status.fail {
            background: #ef4444;
            color: white;
        }

        .status.pending {
            background: #f59e0b;
            color: white;
        }

        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
            display: block;
            margin: 20px auto;
            background: #f0fdf4;
        }

        .data-display {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .data-row {
            margin: 5px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }

        .label {
            font-weight: bold;
            color: #667eea;
            display: inline-block;
            min-width: 150px;
        }

        .leaderboard {
            display: grid;
            gap: 8px;
            margin-top: 10px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .rank {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            min-width: 30px;
        }

        .horse-info {
            flex: 1;
        }

        .horse-name {
            font-weight: bold;
            color: #1f2937;
        }

        .horse-stats {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .badge.boxed {
            background: #fecaca;
            color: #991b1b;
        }

        .badge.overtaking {
            background: #bfdbfe;
            color: #1e40af;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ§ª é©é…å±¤æ¸¬è©¦</h1>
        <p class="subtitle">é©—è­‰ RaceEngineAdapter è³‡æ–™è½‰æ›èˆ‡ API åŒ…è£</p>

        <!-- æ¸¬è©¦æ§åˆ¶ -->
        <div class="test-panel">
            <h2>ğŸ® æ¸¬è©¦æ§åˆ¶</h2>
            <div class="test-controls">
                <button class="btn-primary" onclick="runTest()">é–‹å§‹æ¸¬è©¦</button>
                <button class="btn-success" onclick="startRace()">å•Ÿå‹•æ¯”è³½</button>
                <button class="btn-danger" onclick="stopRace()">åœæ­¢</button>
            </div>
        </div>

        <!-- æ¸¬è©¦çµæœ -->
        <div class="test-panel">
            <h2>âœ… æ¸¬è©¦çµæœ</h2>
            <div id="test-results" class="data-display">
                <div class="data-row">ç­‰å¾…æ¸¬è©¦...</div>
            </div>
        </div>

        <!-- è³‡æ–™è½‰æ›æ¸¬è©¦ -->
        <div class="test-panel">
            <h2>ğŸ”„ è³‡æ–™è½‰æ›é©—è­‰</h2>
            <div id="conversion-results" class="data-display">
                <div class="data-row">å°šæœªåŸ·è¡Œ</div>
            </div>
        </div>

        <!-- å³æ™‚æ’è¡Œæ¦œ -->
        <div class="test-panel">
            <h2>ğŸ“Š å³æ™‚æ’è¡Œæ¦œ</h2>
            <div id="leaderboard" class="leaderboard">
                <div class="data-row">æ¯”è³½å°šæœªé–‹å§‹</div>
            </div>
        </div>

        <!-- Canvas æ¸²æŸ“ -->
        <div class="test-panel">
            <h2>ğŸ¨ è¦–è¦ºåŒ–</h2>
            <canvas id="race-canvas" width="1200" height="600"></canvas>
        </div>
    </div>

    <script type="module">
        import { RaceEngineAdapter } from './RaceEngineAdapter.js';

        // æ¨¡æ“¬éŠæˆ²è³‡æ–™ï¼ˆä¾†è‡ª racetracks.jsï¼‰
        const mockTrack = {
            id: 'tokyo',
            name: 'æ±äº¬ç«¶é¦¬å ´',
            pathPoints: [
                { x: 0.85, y: 0.5 },
                { x: 0.85, y: 0.25 },
                { x: 0.75, y: 0.12 },
                { x: 0.5, y: 0.08 },
                { x: 0.25, y: 0.12 },
                { x: 0.15, y: 0.25 },
                { x: 0.12, y: 0.5 },
                { x: 0.15, y: 0.75 },
                { x: 0.25, y: 0.88 },
                { x: 0.5, y: 0.92 },
                { x: 0.75, y: 0.88 },
                { x: 0.85, y: 0.75 },
                { x: 0.85, y: 0.5 }
            ]
        };

        // æ¨¡æ“¬éŠæˆ²é¦¬åŒ¹è³‡æ–™
        const mockHorses = [
            { id: 'H001', name: 'é–ƒé›»ä¿ ', form: 92, odds: 2.5 },
            { id: 'H002', name: 'ç–¾é¢¨è™Ÿ', form: 88, odds: 3.2 },
            { id: 'H003', name: 'é›·éœ†ç‹', form: 85, odds: 4.1 },
            { id: 'H004', name: 'æ˜Ÿè¾°', form: 78, odds: 5.5 },
            { id: 'H005', name: 'è¿½å¤¢è€…', form: 75, odds: 6.8 },
            { id: 'H006', name: 'å‹‡è€…', form: 70, odds: 8.2 },
            { id: 'H007', name: 'é»‘é§’', form: 65, odds: 10.5 },
            { id: 'H008', name: 'é£›é³¥', form: 60, odds: 12.0 }
        ];

        let adapter = null;
        let animationId = null;
        const canvas = document.getElementById('race-canvas');
        const ctx = canvas.getContext('2d');

        // ====================================
        // æ¸¬è©¦å‡½æ•¸
        // ====================================

        window.runTest = function () {
            const results = [];

            // æ¸¬è©¦ 1: å»ºç«‹é©é…å™¨
            try {
                adapter = new RaceEngineAdapter();
                results.push({ name: 'å»ºç«‹é©é…å™¨', status: 'pass', detail: 'æˆåŠŸå»ºç«‹ RaceEngineAdapter å¯¦ä¾‹' });
            } catch (e) {
                results.push({ name: 'å»ºç«‹é©é…å™¨', status: 'fail', detail: e.message });
                displayTestResults(results);
                return;
            }

            // æ¸¬è©¦ 2: è³½é“è½‰æ›
            try {
                const trackPath = adapter.convertTrackToPath(mockTrack);
                const isValid = Array.isArray(trackPath) && trackPath.length > 0 && trackPath[0].x !== undefined;
                if (isValid) {
                    results.push({ name: 'è³½é“è½‰æ›', status: 'pass', detail: `æˆåŠŸè½‰æ› ${trackPath.length} å€‹è·¯å¾‘é»` });
                } else {
                    results.push({ name: 'è³½é“è½‰æ›', status: 'fail', detail: 'è·¯å¾‘æ ¼å¼éŒ¯èª¤' });
                }
            } catch (e) {
                results.push({ name: 'è³½é“è½‰æ›', status: 'fail', detail: e.message });
            }

            // æ¸¬è©¦ 3: é¦¬åŒ¹è³‡æ–™è½‰æ›
            try {
                const simulatorHorses = adapter.convertHorsesToSimulatorFormat(mockHorses);
                const isValid = simulatorHorses.length === mockHorses.length &&
                    simulatorHorses[0].competitiveFactor !== undefined &&
                    simulatorHorses[0].runningStyle !== undefined;
                if (isValid) {
                    results.push({ name: 'é¦¬åŒ¹è³‡æ–™è½‰æ›', status: 'pass', detail: `æˆåŠŸè½‰æ› ${simulatorHorses.length} åŒ¹é¦¬` });
                    displayConversionResults(mockHorses, simulatorHorses);
                } else {
                    results.push({ name: 'é¦¬åŒ¹è³‡æ–™è½‰æ›', status: 'fail', detail: 'è³‡æ–™æ ¼å¼éŒ¯èª¤' });
                }
            } catch (e) {
                results.push({ name: 'é¦¬åŒ¹è³‡æ–™è½‰æ›', status: 'fail', detail: e.message });
            }

            // æ¸¬è©¦ 4: å•Ÿå‹•æ¯”è³½
            try {
                adapter.startRace(mockHorses, mockTrack);
                const isRunning = adapter.simulator && adapter.simulator.isRunning;
                if (isRunning) {
                    results.push({ name: 'å•Ÿå‹•æ¯”è³½', status: 'pass', detail: 'æ¨¡æ“¬å™¨æˆåŠŸå•Ÿå‹•' });
                } else {
                    results.push({ name: 'å•Ÿå‹•æ¯”è³½', status: 'fail', detail: 'æ¨¡æ“¬å™¨æœªå•Ÿå‹•' });
                }
            } catch (e) {
                results.push({ name: 'å•Ÿå‹•æ¯”è³½', status: 'fail', detail: e.message });
            }

            displayTestResults(results);
        };

        window.startRace = function () {
            if (!adapter) {
                adapter = new RaceEngineAdapter();
            }

            adapter.startRace(mockHorses, mockTrack);

            // å•Ÿå‹•æ¸²æŸ“å¾ªç’°
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            animateRace();
        };

        window.stopRace = function () {
            if (adapter) {
                adapter.stopRace();
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        };

        // ====================================
        // æ¸²æŸ“å‡½æ•¸
        // ====================================

        function animateRace() {
            if (!adapter || !adapter.simulator) return;

            // æ›´æ–°ç‰©ç†
            adapter.update();

            // ç²å–æ¸²æŸ“è³‡æ–™
            const renderData = adapter.getRenderData();

            // æ¸…ç©ºç•«å¸ƒ
            ctx.fillStyle = '#f0fdf4';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç¹ªè£½è³½é“
            drawTrack(renderData.trackPath);

            // ç¹ªè£½é¦¬åŒ¹
            drawHorses(renderData.horses);

            // æ›´æ–°æ’è¡Œæ¦œ
            updateLeaderboard(renderData.leaderboard);

            // æª¢æŸ¥æ˜¯å¦çµæŸ
            if (!adapter.isFinished()) {
                animationId = requestAnimationFrame(animateRace);
            } else {
                displayResults();
            }
        }

        function drawTrack(trackPath) {
            if (!trackPath || trackPath.length === 0) return;

            const scale = 2.0;
            const offsetX = canvas.width / 2;
            const offsetY = canvas.height / 2;

            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 3;
            ctx.beginPath();

            trackPath.forEach((point, i) => {
                const x = offsetX + point.x * scale;
                const y = offsetY + point.y * scale;
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();
        }

        function drawHorses(horses) {
            if (!horses || horses.length === 0) return;

            const scale = 2.0;
            const offsetX = canvas.width / 2;
            const offsetY = canvas.height / 2;

            horses.forEach((horse, index) => {
                const x = offsetX + horse.x * scale;
                const y = offsetY + horse.y * scale;

                // ç¹ªè£½é¦¬åŒ¹
                ctx.fillStyle = `hsl(${index * 45}, 70%, 50%)`;
                ctx.beginPath();
                ctx.arc(x, y, 8, 0, Math.PI * 2);
                ctx.fill();

                // ç¹ªè£½ç·¨è™Ÿ
                ctx.fillStyle = 'white';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(horse.id || (index + 1), x, y);
            });
        }

        function updateLeaderboard(leaderboard) {
            const container = document.getElementById('leaderboard');
            if (!leaderboard || leaderboard.length === 0) return;

            container.innerHTML = leaderboard.map(entry => `
                <div class="leaderboard-item">
                    <div class="rank">#${entry.position}</div>
                    <div class="horse-info">
                        <div class="horse-name">${entry.horseName}</div>
                        <div class="horse-stats">è·é›¢: ${entry.distance.toFixed(1)}m</div>
                    </div>
                    ${entry.isBoxedIn ? '<span class="badge boxed">è¢«å›°</span>' : ''}
                    ${entry.isOvertaking ? '<span class="badge overtaking">è¶…è»Šä¸­</span>' : ''}
                </div>
            `).join('');
        }

        function displayTestResults(results) {
            const container = document.getElementById('test-results');
            container.innerHTML = results.map(r => `
                <div class="data-row">
                    <span class="label">${r.name}</span>
                    <span class="status ${r.status}">${r.status.toUpperCase()}</span>
                    <div style="margin-top: 5px; color: #6b7280;">${r.detail}</div>
                </div>
            `).join('');
        }

        function displayConversionResults(original, converted) {
            const container = document.getElementById('conversion-results');
            container.innerHTML = `
                <div class="data-row">
                    <span class="label">åŸå§‹è³‡æ–™ç¯„ä¾‹</span>
                    <pre>${JSON.stringify(original[0], null, 2)}</pre>
                </div>
                <div class="data-row">
                    <span class="label">è½‰æ›å¾Œè³‡æ–™</span>
                    <pre>${JSON.stringify(converted[0], null, 2)}</pre>
                </div>
            `;
        }

        function displayResults() {
            const results = adapter.getResults();
            alert(`æ¯”è³½çµæŸï¼\n\nå† è»: ${results[0].horseName}\næ™‚é–“: ${results[0].finishTime.toFixed(2)}ç§’`);
        }

        // è‡ªå‹•åŸ·è¡Œæ¸¬è©¦
        window.addEventListener('load', () => {
            setTimeout(() => runTest(), 500);
        });
    </script>
</body>

</html>