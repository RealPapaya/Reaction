<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>è³½é¦¬å¼•æ“é™¤éŒ¯</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }

        #console {
            background: #000;
            padding: 10px;
            border: 2px solid #0f0;
            min-height: 400px;
            white-space: pre;
        }

        button {
            margin: 10px 5px;
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <h1>ğŸ”§ å¼•æ“æ¸¬è©¦èˆ‡é™¤éŒ¯</h1>
    <div>
        <button onclick="testFrenet()">æ¸¬è©¦ Frenet åº§æ¨™</button>
        <button onclick="testSteering()">æ¸¬è©¦è½‰å‘è¡Œç‚º</button>
        <button onclick="testPhysics()">æ¸¬è©¦ç‰©ç†å¼•æ“</button>
        <button onclick="testAI()">æ¸¬è©¦ AI</button>
        <button onclick="testFull()">å®Œæ•´æ¸¬è©¦</button>
        <button onclick="clearConsole()">æ¸…ç©º</button>
    </div>
    <div id="console"></div>
    <div style="margin-top: 20px; background: #000; padding: 10px; border: 2px solid #0f0;">
        <h3>é¦¬åŒ¹ç‹€æ…‹ï¼ˆå³æ™‚ï¼‰</h3>
        <div id="horseStatus" style="font-size: 11px;"></div>
    </div>

    <script src="core/FrenetCoordinates.js"></script>
    <script src="core/SteeringBehaviors.js"></script>
    <script src="core/PhysicsEngine.js"></script>
    <script src="ai/JockeyAI.js"></script>
    <script src="RaceSimulator.js"></script>

    <script>
        const output = document.getElementById('console');

        function log(msg) {
            output.textContent += msg + '\n';
        }

        function clearConsole() {
            output.textContent = '';
        }

        function testFrenet() {
            log('=== æ¸¬è©¦ Frenet åº§æ¨™ç³»çµ± ===');

            try {
                // å»ºç«‹ç°¡å–®çš„åœ“å½¢è³½é“
                const points = [];
                for (let i = 0; i < 20; i++) {
                    const angle = (i / 20) * Math.PI * 2;
                    points.push({
                        x: 100 + Math.cos(angle) * 50,
                        y: 100 + Math.sin(angle) * 50
                    });
                }

                const frenet = new FrenetCoordinate(points);
                log(`âœ… FrenetCoordinate æˆåŠŸå»ºç«‹`);
                log(`   è³½é“é•·åº¦: ${frenet.pathLength.toFixed(2)}ç±³`);

                // æ¸¬è©¦åº§æ¨™è½‰æ›
                const world = frenet.frenetToWorld(50, 2);
                log(`   Frenet(50, 2) â†’ World(${world.x.toFixed(2)}, ${world.y.toFixed(2)})`);

                const frenetBack = frenet.worldToFrenet(world.x, world.y);
                log(`   World â†’ Frenet(${frenetBack.s.toFixed(2)}, ${frenetBack.d.toFixed(2)})`);

            } catch (e) {
                log(`âŒ éŒ¯èª¤: ${e.message}`);
                log(e.stack);
            }
        }

        function testSteering() {
            log('\n=== æ¸¬è©¦è½‰å‘è¡Œç‚º ===');

            try {
                const steering = new SteeringBehavior();
                log(`âœ… SteeringBehavior æˆåŠŸå»ºç«‹`);

                // å»ºç«‹æ¸¬è©¦é¦¬åŒ¹
                const horse = { s: 50, d: 3, speed: 15 };
                const others = [
                    { s: 55, d: 3.2, speed: 12 },  // å‰æ–¹æ…¢é¦¬
                    { s: 50, d: 5, speed: 15 }      // å³å´é¦¬
                ];

                const force = steering.compute(horse, others, 10);
                log(`   æ©«å‘åŠ›: ${force.toFixed(3)}`);

            } catch (e) {
                log(`âŒ éŒ¯èª¤: ${e.message}`);
            }
        }

        function testPhysics() {
            log('\n=== æ¸¬è©¦ç‰©ç†å¼•æ“ ===');

            try {
                const physics = new PhysicsEngine();
                log(`âœ… PhysicsEngine æˆåŠŸå»ºç«‹`);

                // å»ºç«‹ç°¡å–®è³½é“
                const points = [];
                for (let i = 0; i < 20; i++) {
                    const angle = (i / 20) * Math.PI * 2;
                    points.push({
                        x: 100 + Math.cos(angle) * 50,
                        y: 100 + Math.sin(angle) * 50
                    });
                }
                const frenet = new FrenetCoordinate(points);

                const horse = { s: 0, d: 2, speed: 16, lateralSpeed: 0, baseSpeed: 16, runningStyle: 'å‰' };

                // æ›´æ–°ä¸€æ­¥
                physics.update(horse, frenet, 0.016, 0);
                log(`   æ›´æ–°å¾Œä½ç½®: s=${horse.s.toFixed(2)}, d=${horse.d.toFixed(2)}`);

            } catch (e) {
                log(`âŒ éŒ¯èª¤: ${e.message}`);
                log(e.stack);
            }
        }

        function testAI() {
            log('\n=== æ¸¬è©¦ AI é¨æ‰‹ ===');

            try {
                const ai = new JockeyAI();
                log(`âœ… JockeyAI æˆåŠŸå»ºç«‹`);

                const horse = {
                    s: 50,
                    d: 2,
                    speed: 15,
                    runningStyle: 'é€ƒ',
                    baseSpeed: 16
                };
                const others = [];

                // å»ºç«‹ç°¡å–®è³½é“
                const points = [];
                for (let i = 0; i < 20; i++) {
                    const angle = (i / 20) * Math.PI * 2;
                    points.push({
                        x: 100 + Math.cos(angle) * 50,
                        y: 100 + Math.sin(angle) * 50
                    });
                }
                const frenet = new FrenetCoordinate(points);

                const decision = ai.makeDecision(horse, others, frenet, 0.3);
                log(`   æ±ºç­–: ${decision.action}`);
                log(`   ç›®æ¨™æ©«å‘: ${decision.targetD}`);

            } catch (e) {
                log(`âŒ éŒ¯èª¤: ${e.message}`);
                log(e.stack);
            }
        }

        function testFull() {
            log('\n=== å®Œæ•´å¼•æ“æ¸¬è©¦ ===');

            try {
                // å»ºç«‹è³½é“
                const points = [];
                const numPoints = 50;
                for (let i = 0; i < numPoints; i++) {
                    const angle = (i / numPoints) * Math.PI * 2;
                    points.push({
                        x: 300 + Math.cos(angle) * 100,
                        y: 300 + Math.sin(angle) * 100
                    });
                }

                // å»ºç«‹é¦¬åŒ¹
                const horses = [];
                for (let i = 0; i < 4; i++) {
                    horses.push({
                        id: i + 1,
                        name: `é¦¬${i + 1}è™Ÿ`,
                        runningStyle: ['é€ƒ', 'å‰', 'è¿½', 'æ®¿'][i],
                        competitiveFactor: 85 + i * 2,
                        gateNumber: i + 1
                    });
                }

                const simulator = new RaceSimulator(points, horses);
                log(`âœ… RaceSimulator æˆåŠŸå»ºç«‹`);
                log(`   é¦¬åŒ¹æ•¸é‡: ${horses.length}`);
                log(`   è³½é“é•·åº¦: ${simulator.frenet.pathLength.toFixed(2)}ç±³`);

                // é–‹å§‹æ¯”è³½
                simulator.startRace();
                log(`   æ¯”è³½é–‹å§‹ï¼`);

                // æ¨¡æ“¬å¹¾æ­¥
                for (let i = 0; i < 5; i++) {
                    simulator.update();
                }

                const state = simulator.getRaceState();
                log(`   æ¯”è³½æ™‚é–“: ${state.raceTime.toFixed(2)}ç§’`);
                log(`   é€²åº¦: ${(state.raceProgress * 100).toFixed(1)}%`);

                log('\n   é ˜å…ˆæ¦œ:');
                state.leaderboard.slice(0, 3).forEach(item => {
                    log(`   ${item.position}. ${item.horse.name} - ${item.distance.toFixed(1)}m`);
                });

                // å•Ÿå‹•å³æ™‚é¡¯ç¤º
                const intervalId = setInterval(() => {
                    if (!simulator.isRunning) {
                        clearInterval(intervalId);
                        return;
                    }

                    simulator.update();

                    const statusDiv = document.getElementById('horseStatus');
                    if (statusDiv) {
                        const sorted = [...simulator.horses].sort((a, b) => b.s - a.s);
                        statusDiv.innerHTML = sorted.map((h, i) =>
                            `${i + 1}. ${h.name}: Speed=${h.speed.toFixed(2)}m/s, D=${h.d.toFixed(2)}m, S=${h.s.toFixed(1)}m ${h.isBoxedIn ? 'â˜ ï¸è¢«å›°' : ''}`
                        ).join('<br>');
                    }
                }, 100);

                log('\nâ¡ï¸ æ¯”è³½é€²è¡Œä¸­ï¼Œè«‹æŸ¥çœ‹ä¸‹æ–¹é¦¬åŒ¹ç‹€æ…‹...');

                log('\nâœ… æ‰€æœ‰æ¸¬è©¦é€šéï¼');

            } catch (e) {
                log(`âŒ éŒ¯èª¤: ${e.message}`);
                log(e.stack);
            }
        }

        // è‡ªå‹•åŸ·è¡Œå®Œæ•´æ¸¬è©¦
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('=== è‡ªå‹•åŸ·è¡Œå®Œæ•´æ¸¬è©¦ ===\n');
                testFull();
            }, 500);
        });
    </script>
</body>

</html>